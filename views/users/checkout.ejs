<%- include('../layouts/header.ejs') %>


    <div class="order_box container mt-5 ml-auto ">
        <h2 class="mb-4">Checkout</h2>
        
            <div class="shipping-address">

                <%if(locals.data){%>
                    <h5>Shipping Address</h5>
                    <%for(i=0;i<data[0].address.length;i++){%>

                        <label class="custom-radio">
                            <input type="radio" id="addressselect" name="addressselect" value="<%=data[0].address[i]._id%>">
                        </label>


                        <div class="mt-3 mb-3 bg-light p-2 rounded text-dark">
                            <div class="d-flex">
                                <small class="me-4">FullName: <%=data[0].address[i].name%></small>

                                <svg class="ms-auto text-dark" style="margin-left: 13rem;" aria-hidden="true"
                                    onclick="removeAdress('<%=data._id%>' , '<%=locals.data[0].address[i]._id%>')"
                                    xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-trash-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z" />
                                </svg>
                                </a>
                            </div>
                            <div class="d-flex">
                                <small class="me-1">Number: <%=data[0].address[i].number%></small>,
                                <small>Alt Number: <%=data[0].address[i].altNumber%></small>
                            </div>
                            <div class="d-flex">
                                <small>Pincode: <%=data[0].address[i].pinCode%></small>
                            </div>
                            <div class="d-flex">
                                <small>House: <%=data[0].address[i].house%></small>
                            </div>
                            <div class="d-flex">
                                <small class="me-5">Area: <%=data[0].address[i].area%></small>
                                <small>Landmark: <%=data[0].address[i].landmark%></small>
                            </div>
                            <div class="d-flex">
                                <small class="me-4">Town: <%=data[0].address[i].town%></small>
                                <small class="me-4">State: <%=data[0].address[i].state%></small>
                            </div>


                            <a class="btn btn-info " id="edit" target="__blank"
                                href="/editAdress?id=<%=data[0].address[i]._id%>">Edit</a>
                        </div>
                        <%}%>
                            <%}%>

                                <a href="/addAdress" class="btn btn-primary">Add Address</a>
            </div>
            <div class="form-group">
                <%if(locals.total){%>
                    <label for="total-price">Subtotal</label>
                    <br>
                    <%=total%>
                        <%}%>

            </div>
            <div class="form-group">
                <label for="payment-method">Payment Method</label>
                <select class="form-control" id="payment-method" name="payment-method" required>
                    <option value="online-payment">Online Payment</option>
                    <option value="wallet-balance">Wallet Balance</option>
                    <option id="f-option5" name="selector" value="cod" ><label for="f-option5">Cash on Delivery</label></option>
                </select>
            </div>
            <div class="form-group">
                <%if(locals.total){%>
                    <label for="total-price" id="discount1">Total Price</label>
                    <br>
                    <%=total%>
                        <%}%>

            </div>
            <button type="submit" class="btn btn-primary" onclick="makePurchase('<%=total%>')">Place Order</button>
        
    </div>


    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .shipping-address {
            margin-bottom: 20px;
        }

        .order_box {
            background: #e5ecee;
            padding: 30px;
        }

        /* Style the radio input if needed */
        /* .shipping-address input[type="radio"] {
    /* Add styles here */
        /* } */

        /* Style the address details container */
        /* .address-details {
    /* Add styles here */
        */

        /* Style the custom radio button */
        .custom-radio {
            position: relative;
            display: inline-block;
            cursor: pointer;
            font-size: 16px;
            margin-right: 20px;
            /* Adjust the spacing between radio buttons */
        }



        /* Style the radio button when it's checked */
        input[type="radio"]:checked+.radio-button {
            background-color: #333;
            /* Set the background color when checked */
        }

    </style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <%- include('../layouts/footer.ejs') %>

        <script>
            function removeAdress(userId, addressId) {
                $.ajax({
                    url: '/removeAdd',
                    method: 'post',
                    data: {
                        userId: userId,
                        addressId: addressId,
                    },

                    success: (response) => {
                        location.href = "/address"
                    }
                })







            }
        </script>

        <script>
            function makePurchase(GrandTotal) {


                let addressId = $("#addressselect:checked").val();
                if (!addressId) {
                    Swal.fire({
                        title: "select address",
                        text: "",
                        icon: "error",
                        timer: 2000
                    })
                } else {

                    console.log(addressId);
                    // let payment = $(".radio:checked").val();
                    let codbutton = document.getElementById("f-option5")
                    // let onlinebutton = document.getElementById("f-option6")
                    // let walletbutton = document.getElementById("wallet")
                    let payment
                    if (codbutton.checked) {
                        payment = codbutton.value
                    }
                    // } else if (onlinebutton.checked) {
                    //     payment = onlinebutton.value
                    // } else if (walletbutton.checked) {
                    //     payment = walletbutton.value
                    // }
                    console.log(payment);
                    $.ajax({
                        url: '/confirmation',
                        method: 'post',
                        data: {
                            addressId: addressId,
                            payment: payment,
                            GrandTotal: document.getElementById("discount1").innerText,
                            // discount: document.getElementById("code").innerText

                        },
                        success: (response) => {
                            // console.log(response.status)
                            if (response.method == 'cod') {
                                console.log("heloooooooooooooo");
                                Swal.fire({
                                    title: "Order success",
                                    text: "order placed successfully",
                                    icon: "success",
                                    showCancelButton: true,
                                    confirmButtonText: "view orders",
                                    cancelButtonText: "continue shopping",
                                    reverseButtons: true
                                })
                                    .then(function (result) {
                                        if (result.value) {
                                            location.href = '/Account'
                                        } else if (result.dismiss === "cancel") {
                                            location.href = '/productList'
                                        }
                                    });
                                }

                            // } else if (response.method == 'online') {
                            //     var options = {
                            //         "key": "rzp_test_80jNgNYgTgs47P", // Enter the Key ID generated from the Dashboard
                            //         "amount": response.order.finalAmount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                            //         "currency": "INR",
                            //         "name": "SHOE CART", //your business name
                            //         "description": "Test Transaction",
                            //         "image": "https://example.com/your_logo",
                            //         "order_id": response.razorpayOrder.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                            //         "handler": function (status) {

                            //             verifyPayment(response, status)
                            //         },
                            //         "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
                            //             "name": "Gaurav Kumar", //your customer's name
                            //             "email": "gaurav.kumar@example.com",
                            //             "contact": "9000090000"  //Provide the customer's phone number for better conversion rates 
                            //         },
                            //         "notes": {
                            //             "address": "Razorpay Corporate Office"
                            //         },
                            //         "theme": {
                            //             "color": "#3399cc"
                            //         }
                            //     };
                            //     var rzp1 = new Razorpay(options);
                            //     rzp1.open();


                            // } 
                            else {
                                Swal.fire({
                                    title: 'Error Occured',
                                    text: "Can't process order error occured",
                                    icon: 'fail',
                                    timer: 5000
                                })

                            }
                        }
                    })
                }




            }
        </script>