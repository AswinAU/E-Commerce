<%- include('../layouts/header.ejs') %>

    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index-2.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Your Cart
                </div>
            </div>
        </div>
        <section class="cart_area">
            <div class="container">
                <div class="cart_inner">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">Product</th>
                                    <th scope="col">Price</th>
                                    <th scope="col" style="width: 250px;">Quantity</th>
                                    <th scope="col">Total</th>
                                    <th scope="col">Action</th>

                                </tr>
                            </thead>
                            <tbody>
                                <%if(locals.cart){%>
                                    <%for(i=0;i<cart.length;i++){%>
                                        <tr>
                                            <td>
                                                <div class="media">
                                                    <img src="/upload/product/<%= cart[i]?.ProductDetails[0]?.images[i] %>"
                                                        style="height: 100px; width: 100px;" alt="">
                                                    <div class="media-body">
                                                        <p>
                                                            <%=cart[i]?.ProductDetails[0]?.name%>

                                                        </p>

                                                    </div>

                                                </div>
                                                <br><br><br>

                                            </td>
                                            <td>
                                                <h5 id="<%=cart[i]?.ProductDetails[0]?._id%>price">
                                                    <%=cart[i]?.ProductDetails[0]?.sale_price%>
                                                </h5>
                                            </td>


                                            <td>

                                                <div class="input-group mb-3" style="width: 170px;">
                                                    <button class="btn btn-white border border-secondary px-3"
                                                        type="button" id="decrementButton" data-mdb-ripple-color="dark"
                                                        onclick="changeQuantity('<%=cart[i]?._id%>' , '<%=cart[i]?.proId%>' ,-1,' <%=cart[i]?.ProductDetails[0]?.quantity%>')">
                                                        -
                                                    </button>
                                                    <input name="quantity" type="text"
                                                        id="<%=cart[i]?.ProductDetails[0]?._id%>"
                                                        class="form-control text-center border border-secondary item-quantity"
                                                        value="<%=cart[i]?.quantity%>"
                                                        aria-label="Example text with button addon"
                                                        aria-describedby="decrementButton" readonly />
                                                    <!-- Add readonly attribute here -->
                                                    <button class="btn btn-white border border-secondary px-3"
                                                        type="button" id="incrementButton" data-mdb-ripple-color="dark"
                                                        onclick="changeQuantity('<%=cart[i]?._id%>' , '<%=cart[i]?.proId%>' ,1,' <%=cart[i]?.ProductDetails[0]?.quantity%>')">
                                                        +
                                                    </button>
                                                </div>
                                            </td>

                                            <td>
                                                <h5 id="<%=cart[i]?.ProductDetails[0]?._id%>pro-total"
                                                    class="item-total">
                                                    <%=parseInt(cart[i]?.ProductDetails[0]?.sale_price)*parseInt(cart[i]?.quantity)%>
                                                </h5>
                                            </td>

                                            <td> <button type="button"
                                                    onclick="removeFromCart('<%=cart[i]?._id%>' , '<%=cart[i]?.proId%>')"
                                                    class="btn btn-primary">Delete</button></td>
                                        </tr>
                                        <%}%>
                                            <%}%>
                                                <tr>
                                                <tr>
                                                    <td colspan="3"></td>
                                                    <td class="cart-total">
                                                        <strong>Cart Total</strong> ₹<span id="final-amount">
                                                            <%if(locals.total){%>
                                                                <%=total%>
                                                                    <%}%>
                                                        </span>
                                                    </td>
                                                    <td></td>
                                                </tr>


                    </div>
                    </td>
                    </tr>

                    </tbody>
                    </table>

                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-4 ">

                        <div class="checkout_btn_inner col-8 col-lg-9 col-md-4 ">
                            <form action="/check-out" method="post">
                                <input type="hidden" name="total" id="totalInput" <%if(locals.total){%> value="
                                <%=total%>"<%}%>>
                                        <% if (cart.length===0) { %>
                                            
                                            </div>
                                            <% } else { %>
                                                <button type="submit"
                                                    class="btn btn-success w-100 shadow-0 mb-2">proceed to
                                                    checkout</button>
                                                <% } %>
                            </form>
                        </div>



                    </div>
                </div>
            </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        function changeQuantity(userId, proId, count, quantity) {
            const qty = document.getElementById(proId)


            if (qty.value > 1 || count == 1) {

                if (parseInt(qty.value) + 1 > quantity && count == 1) {
                    Swal.fire({
                        title: 'STOCK!',
                        text: 'Product is out of stock.',
                        icon: 'error',
                        timer: 5000
                    })
                } else {



                    qty.value = Number(qty.value) + count
                    const sub = document.getElementById(`${proId}pro-total`)

                    const subPrice = document.getElementById(`${proId}price`)

                    sub.textContent = qty.value * subPrice.textContent





                    const items = document.querySelectorAll(".item-total")

                    const final = document.querySelector("#final-amount")

                    // let finalamount = final.innerHTML;
                    // alert(finalamount,'finalfinal')
                    // console.log(finalamount,'final');

                    let amt = 0
                    items.forEach(item => {
                        amt += Number(item.innerText)
                    })
                    final.innerText = amt

                    let quantity = qty.value - count

                    $.ajax({
                        url: "/change-quantity",
                        method: 'post',
                        data: {
                            userId: userId,
                            proId: proId,
                            count: count,
                            quantity: quantity,
                        },
                        success: (response) => {

                            console.log(response.status)

                            if (response.status == true) {

                                var totalInput = document.getElementsByName('total')[0];
                                totalInput.value = final.innerText
                                // alert(totalInput.value,'totalInput.value')
                                console.log(totalInput.value, 'totalInput.value');
                                let Total = totalInput.value
                                // location.reload();
                                hello(Total)
                            } else {

                                let total = parseInt(quantity) + parseInt(count);
                                const h = document.getElementById(proId).value = total;

                            }
                        }
                    })
                }
            }
            function hello(total) {

                $.ajax({
                    url: "/change-quantity2",
                    method: 'post',
                    data: {
                        finalAmount: total
                    },
                })
            }
        }
    </script>

    <script>
        function removeFromCart(userId, proId) {
            console.log('removeFromCart')
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/removeFromCart',
                        method: 'post',
                        data: {
                            userId: userId,
                            proId: proId,
                        },
                        success: (response) => {
                            if (response == true) {
                                var totalInput = document.getElementsByName('total')[0];
                                var totalValue = totalInput.value;

                                //alert(totalValue, 'totalInput.value')
                                console.log(totalValue, 'totalInput.value');
                                hello(totalValue)
                                location.reload()

                            } else {
                                location.reload()
                            }

                        }
                    })
                    function hello(total) {

                        $.ajax({
                            url: "/change-quantity2",
                            method: 'post',
                            data: {
                                finalAmount: total
                            },
                        })
                    }

                }
            })
        }
    </script>


    <%- include('../layouts/footer.ejs') %>